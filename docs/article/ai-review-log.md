# AI Code Review Log

> Task 6: Advanced Engineering Documentation
> 주제: "AI의 눈으로 약점 찾기, 인간의 머리로 판단하기"

---

## 리뷰 개요

| 항목 | 내용 |
|------|------|
| 일시 | 2026-01-13 |
| AI 도구 | Claude Code (Opus 4.5) |
| 대상 | hoops 프로젝트 백엔드 |
| 분석 관점 | N+1 쿼리, 동시성, 성능 병목, 확장성 |

---

## 리뷰 대화 기록

### 1단계: AI 코드 분석 요청

**Human**:
> 핵심 서비스 코드들을 분석해서 다음 관점에서 잠재적 이슈를 찾아주세요:
> 1. N+1 쿼리 문제
> 2. 동시성 이슈
> 3. 성능 병목
> 4. 확장성 문제

**AI 분석 결과**: 10개 잠재적 이슈 도출

| # | 카테고리 | 위치 | 문제 |
|---|---------|------|------|
| 1 | N+1 | ParticipationService:106-123 | 참가 검증 시 Match 반복 조회 |
| 2 | N+1 | NotificationService:35-36 | 페이지네이션 없이 전체 알림 로드 |
| 3 | N+1 | ParticipationController:94-108 | 참가자별 User 정보 개별 조회 |
| 4 | 동시성 | MatchEntity:27-28 | 정원 마감 시 Race Condition |
| 5 | 동시성 | ParticipationService:207-246 | 승인/거절 동시 요청 시 상태 불일치 |
| 6 | 동시성 | MatchStatusUpdater:30-65 | 배치 중복 실행 시 상태 누락 |
| 7 | 성능 | JpaMatchRepository:16-22 | 위치 기반 검색 Full Table Scan |
| 8 | 성능 | UserRepositoryImpl:22-34 | UPDATE 시 불필요한 SELECT |
| 9 | 성능 | MatchCreator:64-75 | 중복 호스팅 검증 시 전체 로드 |
| 10 | 성능 | JpaNotificationRepository:14-15 | unread count 매번 COUNT 쿼리 |

---

### 2단계: 비즈니스 컨텍스트 질문

**AI 질문**:
> 이 서비스의 핵심 사용 시나리오는 무엇인가요?
> 1. 경기 참가 신청이 몰리는 상황
> 2. 지도에서 주변 경기 검색
> 3. 호스트가 참가자 승인하는 상황
> 4. 알림 확인
>
> 어떤 시나리오가 가장 트래픽이 높을 것으로 예상하시나요?

**Human**:
> 2번이 가장 높다고 봅니다. 1시간에 10~100명 이하로 사용한다고 봅니다.

---

### 3단계: 이슈별 판단 논의

**AI 의견 제시**:

#### 동시성 이슈 (4, 5번)
> 시간당 10~100명이면 동시 요청 확률이 매우 낮습니다.
> 하지만 **데이터 정합성** 문제이므로, 발생 시 사용자 신뢰도에 직접 영향을 줍니다.
>
> 수용할지, 기각할지 어떻게 생각하시나요?
> 만약 수용한다면, **비관적 락**과 **Redis 분산 락** 중 어떤 방향이 좋을까요?

#### 위치 검색 이슈 (7번)
> 메인 페이지 핵심 기능이고 가장 트래픽이 높다고 하셨으니, 이 이슈는 수용 대상으로 보입니다.
> 현재 예상되는 경기 데이터 규모는 어느 정도인가요?

#### N+1 이슈 (1, 2, 3번)
> 시간당 100명 규모에서 N+1은 체감되지 않을 가능성이 높습니다.
> 이 이슈들은 **기각**으로 처리하는 게 어떨까요?

**Human**:
> 예상되는 경기수는 수백개 정도이고, n+1이슈는 생각보다 체감되지 않습니다.
> 정원마감시 race condition은 비관적락 혹은 redis 분산 락 중 뭘 사용해도 문제가 없지만,
> 비관적 락이 추가적인 인프라가 필요없어서 좋을 것 같습니다.

---

### 4단계: 최종 판단

**AI 제안**:
> | 이슈 | 판단 | 근거 |
> |------|------|------|
> | 동시성 (4, 5) | **수용** | 데이터 정합성 중요, 비관적 락 선택 |
> | N+1 (1, 2, 3) | **기각** | 현재 규모에서 체감 안됨 |
> | 위치 검색 (7) | **기각** | 수백 개 규모면 Full Scan도 수십 ms |
> | 나머지 (6, 8, 9, 10) | **기각** | 단일 서버, 낮은 트래픽 |

**Human**:
> 동의해요

---

## 최종 결정 요약

### 수용된 이슈 (Accepted)
1. **정원 마감 Race Condition** → 비관적 락 적용
2. **승인/거절 동시 요청** → @Version 추가 + 상태 검증 강화

### 기각된 이슈 (Rejected)
1. N+1: 참가 검증 시 Match 조회 - 이미 배치 조회 구현됨
2. N+1: 알림 목록 페이지네이션 - MVP 우선
3. N+1: 참가자 목록 User 조회 - 최대 20명 제한
4. 위치 검색 Full Scan - 수백 건은 ms 단위
5. 배치 중복 실행 - 단일 서버 구성
6. UPDATE 전 SELECT - 빈도 낮음
7. 중복 호스팅 검증 - 호스트당 경기 수십 개
8. unread count COUNT - 시간당 100회 수준

---

## 판단 기준 정리

Human Refinement 시 적용한 핵심 기준:

1. **현재 규모 기준 판단**: 미래 트래픽이 아닌 현재 예상 규모(시간당 100명, 경기 수백 개)
2. **데이터 정합성 우선**: 성능보다 정확성이 중요한 이슈는 수용
3. **인프라 복잡도 최소화**: Redis 등 추가 인프라 없이 해결 가능한 방안 선호
4. **Over-engineering 지양**: "나중에 필요하면 그때 하자" 원칙

---

## 참고

- 고도화 포인트 기술서: `docs/article/optimization-report.md`
