# 비즈니스 규칙과 제약 (Business Rules & Constraints)

> 이 문서는 **각 도메인의 규칙과 제약**을 정의합니다.
> "왜 이런 제약이 있는가?"를 이해하기 위한 것입니다.

---

## Match Context (경기 관련 규칙)

### 경기 생성 규칙

| 규칙 | 조건 | 설명 |
|------|------|------|
| **Host 필수** | 경기마다 Host는 반드시 1명 필요 | Host 없이는 경기 불가 |
| **Host 신뢰도** | 신뢰도 3.0 이상 | 신뢰도가 낮은 사용자는 경기 생성 불가 |
| **Host 자동 포함** | 경기 생성 시 | Host는 자동으로 참여 확정됨 (3명 더 필요) |

### 경기의 정원 규칙

| 규칙 | 조건 | 설명 |
|------|------|------|
| **고정 정원** | 최대 n명 | 정원은 변경 불가능 |
| **Host 승인 기반 확정** | Host가 n명 승인 | Host가 n명을 승인하면 자동으로 경기 상태 변경: RECRUITING → CONFIRMED |
| **신청 불가** | 상태 = CONFIRMED | 정원이 가득 찬 경기는 신청 불가 |
| **신청 제한 없음** | 상태 = RECRUITING | 모집 중에는 n명 이상 신청 가능 (Host가 선택) |

### 경기 일정 규칙

| 규칙 | 조건 | 설명 |
|------|------|------|
| **중복 경기 허용** | 같은 시간, 같은 코트 | 한 코트에서 동일 시간대에 여러 경기 생성 가능 |
| **예시** | "내일 오후 7시, 광주 코트" | 같은 시간, 같은 장소에 여러 경기 동시 진행 가능 |
| **실제 시나리오** | 대형 코트 (여러 골대) | 넓은 코트에서 동시에 여러 팀이 경기 가능 |

### 경기 상태 전환 규칙

| 현재 상태 | 다음 상태 | 조건 | 설명 |
|---------|---------|------|------|
| RECRUITING | CONFIRMED | Host가 n명 승인 | Host가 정확히 n명을 승인하면 자동 전환 |
| CONFIRMED | COMPLETED | 경기 시간 경과 | 경기 시간이 지나면 자동 전환 |
| RECRUITING / CONFIRMED | CANCELLED | Host 취소 | Host가 경기 취소 |
| COMPLETED | - | 최종 상태 | 더 이상 상태 변경 없음 |

### 경기의 불변식 (Invariant)

```
1. maxParticipants는 항상 n (변경 불가)
2. Host는 반드시 1명 존재
3. approvedCount = n이면 경기 자동 CONFIRMED (승인된 참여자 수)
4. RECRUITING 상태에서만 신청 가능
5. CONFIRMED 상태에서는 신청 불가
6. Host는 경기 생성 시 자동으로 Approved 상태 (자동 승인)
7. Host는 신청을 n명 이상 승인할 수 없음 (본인 포함)
```

---

## Participation Context (신청 관련 규칙)

### 신청 생성 규칙

| 규칙 | 조건 | 설명 |
|------|------|------|
| **경기 상태** | RECRUITING 상태만 | CONFIRMED 상태 경기는 신청 불가 |
| **중복 신청 불가** | 1 User : 1 Match | 한 사용자가 같은 경기에 2번 신청 불가 |
| **시간 겹침 불가** | 겹치는 시간대 | 같은 시간대의 다른 경기는 신청 불가 |
| **초기 상태** | PENDING_APPROVAL | 신청 즉시 승인 대기 상태 |
| **예시** | "내일 7~9시" 경기에 신청 | 같은 날짜, 겹치는 시간의 다른 경기는 신청 불가 |

### Host 승인/거부 규칙

| 규칙 | 조건 | 설명 |
|------|------|------|
| **승인 권한** | Host만 가능 | 경기를 만든 Host만 신청 승인/거부 가능 |
| **승인 제한** | 최대 (n-1)명 | Host 본인 포함 총 n명까지만 승인 가능 |
| **선택적 승인** | Host 재량 | Host는 신청자의 신뢰도, 프로필 등을 보고 선택 가능 |
| **거부 사유 없음** | 거부 시 | 거부 사유는 선택적 (명시 안 해도 됨) |
| **자동 확정** | n명 승인 시 | Host가 (n-1)명을 승인하면 경기 자동 CONFIRMED |

### 신청 상태 전환 규칙

| 현재 상태 | 다음 상태 | 조건 | 설명 |
|---------|---------|------|------|
| PENDING_APPROVAL | APPROVED | Host 승인 | Host가 "승인" 버튼 클릭 |
| PENDING_APPROVAL | REJECTED | Host 거부 | Host가 "거부" 버튼 클릭 |
| APPROVED | CONFIRMED | 경기 CONFIRMED | Host가 n명 승인 완료 → 경기 자동 확정 |
| CONFIRMED | COMPLETED | 경기 완료 + 참석 | 경기가 정상 완료되고 참석함 |
| CONFIRMED | NO_SHOW | 경기 완료 + 미참석 | 경기 시간이 지났는데 나타나지 않음 |
| PENDING_APPROVAL / APPROVED / CONFIRMED | CANCELLED | 신청자 취소 또는 경기 취소 | 신청을 취소하거나 경기 자체가 취소됨 |

### 경기와 신청의 동기화 규칙

| 상황 | 신청 변화 | 설명 |
|------|---------|------|
| **Host가 n명 승인** | APPROVED → CONFIRMED | Host가 n명을 승인하면 경기가 CONFIRMED되고 승인된 모든 신청도 자동 CONFIRMED |
| **경기 취소됨** | PENDING_APPROVAL / APPROVED / CONFIRMED → CANCELLED | 경기가 취소되면 모든 신청도 취소됨 |

### 신청의 불변식 (Invariant)

```
1. (userId, matchId) 조합은 유일 (중복 신청 불가)
2. PENDING_APPROVAL 상태에서는 Host만 알림 받음
3. APPROVED 상태에서는 신청자에게만 승인 알림
4. CONFIRMED 상태에서는 모든 참여자가 알림 받음
5. Host가 승인한 참여자 수 = n이면 경기가 자동으로 CONFIRMED됨
6. REJECTED 상태는 최종 상태 (변경 불가)
```

---

## User Context (사용자 관련 규칙)

### 신뢰도 계산 규칙

| 항목 | 계산 방식 | 설명 |
|------|---------|------|
| **신뢰도 점수** | (모든 평점의 합) / 평가 개수 | 평점들의 평균값 (1.0 ~ 5.0) |
| **자동 계산** | 평가 추가/변경 시 | 새로운 평가가 추가되면 자동으로 다시 계산 |
| **최소값** | 1.0 | 신뢰도는 1.0 이상 |
| **최대값** | 5.0 | 신뢰도는 5.0 이하 |

### 신뢰도 변동 규칙

| 상황 | 변동 | 설명 |
|------|------|------|
| **경기 정상 완료** | +0.2 | 경기에 참석해서 완료 |
| **높은 평점 (5점)** | +0.3 | 상대방이 5점 주기 |
| **좋은 리뷰** | +0.1 | 긍정적인 평가 받기 |
| **노쇼** | -0.5 | 확정된 경기에 나타나지 않음 (매우 심각) |
| **낮은 평점 (1~2점)** | -0.3 | 상대방이 1~2점 주기 |
| **안 좋은 리뷰** | -0.1 | 부정적인 평가 받기 |

### 신뢰도 점수에 따른 제약

| 신뢰도 점수 | 상태 | 제약 |
|-----------|------|------|
| 3.0 ~ 5.0 | 정상 | 제약 없음 (모든 기능 사용 가능) |
| 2.0 ~ 2.9 | ⚠️ 경고 | 일부 기능 제한 (예: 경기 생성 불가) |
| 0.0 ~ 1.9 | 🚫 자동 정지 | 경기 생성/신청 불가 |

### 노쇼 규칙

| 규칙 | 조건 | 설명 |
|------|------|------|
| **기록 조건** | 경기 CONFIRMED + 경기 시간 경과 + 미참석 | 3가지 조건을 모두 만족할 때만 기록 |
| **신뢰도 감소** | -0.5점 | 노쇼 1회당 신뢰도 감소 (심각함) |
| **누적** | No-Show Count | 노쇼 횟수 누적 |
| **자동 정지** | No-Show Count ≥ 3 | 노쇼 3회 이상이면 자동 정지 |

### 사용자 상태 규칙

| 사용자 상태 | 신뢰도 | 조건 | 설명 |
|----------|--------|------|------|
| 정상 | ≥ 3.0 | - | 모든 기능 사용 가능 |
| 제한됨 | 2.0 ~ 2.9 | - | 일부 기능 제한 |
| 정지됨 | < 2.0 또는 노쇼 ≥ 3 | - | 경기 생성/신청 불가 |

### 리뷰 규칙

| 규칙 | 조건 | 설명 |
|------|------|------|
| **1회 제한** | 같은 경기 | 같은 경기에 대해 1명당 1회만 리뷰 작성 가능 |
| **경기 완료 후** | 경기 COMPLETED | 경기가 완료된 후에만 리뷰 작성 가능 |
| **상호 평가 가능** | 같은 경기 참여자 | 경기에 참여한 사람들끼리만 평가 가능 |

### 사용자의 불변식 (Invariant)

```
1. ReputationScore는 자동 계산됨 (수동 변경 불가)
2. ReputationScore = (sum of ratings) / count of ratings
3. 신뢰도 < 2.0 또는 노쇼 3회 이상 → 자동 정지
4. Review는 (userId, matchId) 조합이 유일
5. 같은 경기에 대해 1명당 1회만 review 작성 가능
```

---

## Location Context (장소 관련 규칙)

### 코트 규칙

| 규칙 | 조건 | 설명 |
|------|------|------|
| **위치 필수** | 모든 코트 | 위도, 경도 필수 입력 |

### 위치 기반 검색 규칙

| 규칙 | 조건 | 설명 |
|------|------|------|
| **기본 반경** | 2km | 사용자 위치 기준 반경 2km 내 경기 조회 |
| **사용자 위치** | GPS 권한 필요 | 사용자의 현재 위치 접근 권한 필요 |
| **지도 표시** | 마커 기반 | 각 경기는 코트 위치에 마커로 표시 |
| **마커 클릭** | 경기 정보 표시 | 마커 클릭 시 경기 상세 정보 팝업 |
| **거리 계산** | 직선 거리 | 사용자 위치와 코트 간 직선 거리 기준 |
| **같은 위치 여러 경기** | 마커 클러스터링 | 같은 코트에 여러 경기 있을 시 마커 묶음으로 표시 |

---

## 📋 규칙 우선순위 정리

### 최우선 (절대 깨져선 안 됨)

```
1. 경기 정원은 n명 (변경 불가)
2. Host는 필수 (1명)
3. (userId, matchId)는 유일 (중복 신청 불가)
4. 신뢰도 < 2.0 또는 노쇼 3회 → 자동 정지
5. Host가 n명 승인하면 경기 자동 CONFIRMED
6. 경기가 CONFIRMED되면 승인된 신청도 자동 CONFIRMED
```

### 중요 (구현 시 주의)

```
7. 신뢰도 점수 자동 계산
8. 상태 자동 전환 (경기/신청 모두)
9. 알림 발송 (이벤트 기반)
10. Host 승인/거부는 수동, 경기 확정은 자동
11. 위치 기반 검색 (반경 2km)
```

### 운영 (시간이 지나도 조정 가능)

```
12. 신뢰도 변동량 (±0.2 ~ ±0.5)
13. 노쇼 정지 기준 (3회 이상)
14. Host 신뢰도 기준 (3.0 이상)
15. 검색 반경 기본값 (2km, 추후 조정 가능)
```

---

**이 규칙들은 도메인의 "핵심 비즈니스 로직"입니다. 코드 구현 시 반드시 지켜져야 합니다.**