# Business Logic Specification

## 개요
본 문서는 hoops 서비스의 비즈니스 규칙과 도메인 로직을 정의합니다.

---

## Match (경기) 도메인

### 경기 상태 (MatchStatus)

| 상태 | 설명 | 자동 전이 |
|------|------|----------|
| PENDING | 모집 중 | 경기 시작 시간 도달 시 → IN_PROGRESS |
| CONFIRMED | 참가 확정 (정원 충족) | 경기 시작 시간 도달 시 → IN_PROGRESS |
| FULL | 정원 마감 | 경기 시작 시간 도달 시 → IN_PROGRESS |
| IN_PROGRESS | 경기 진행 중 | 경기 종료 시간 도달 시 → ENDED |
| ENDED | 경기 종료 | - |
| CANCELLED | 경기 취소됨 | - |

### 경기 생성 정책

| 항목 | 정책 |
|------|------|
| 생성 권한 | 로그인한 사용자만 가능 |
| 호스트 자동 참가 | **호스트는 자동으로 참가자로 등록됨** (currentParticipants = 1로 시작) |
| 장소/시간 중복 | **허용** (같은 장소, 같은 시간에 여러 경기 생성 가능) |
| 중복 생성 알림 | 없음 |

### 경기 취소 정책

| 항목 | 정책 |
|------|------|
| 취소 권한 | **호스트만** 가능 |
| 취소 사유 | **필수** (API 요청 시 reason 필드 필수) |
| 취소 가능 시간 | 경기 시작 **2시간 전**까지 |
| 참가자 알림 | 모든 참가자에게 취소 알림 발송 |
| 참가자 상태 변경 | 모든 참가자 → MATCH_CANCELLED |

### 경기 복구 정책

| 항목 | 정책 |
|------|------|
| 복구 권한 | **호스트만** 가능 |
| 복구 가능 시간 | 취소 후 **1시간 이내** |
| 복구 후 상태 | CANCELLED → PENDING |

---

## Participation (참가) 도메인

### 참가 상태 (ParticipationStatus)

| 상태 | 설명 | 가능한 액션 |
|------|------|------------|
| PENDING | 참가 신청 대기 중 | 취소(본인), 승인/거절(호스트) |
| CONFIRMED | 참가 승인됨 | 취소(본인) |
| REJECTED | 참가 거절됨 | **없음** |
| CANCELLED | 참가 취소됨 | 재신청(본인) |
| MATCH_CANCELLED | 경기 취소로 인한 취소 | **없음** |

### 상태 전이 다이어그램

```
[신청] → PENDING
            ├─ [호스트 승인] → CONFIRMED
            │                    └─ [본인 취소] → CANCELLED
            ├─ [호스트 거절] → REJECTED (종료)
            └─ [본인 취소] → CANCELLED
                               └─ [재신청] → PENDING
```

### 참가 신청 정책

| 항목 | 정책 |
|------|------|
| 신청 권한 | 로그인한 사용자 |
| 호스트 신청 | **불가** (자기 경기에 참가 신청 불가) |
| 중복 신청 | **불가** (PENDING/CONFIRMED 상태가 있으면 거부) |
| 정원 초과 | **불가** (정원이 찬 경기에 신청 불가) |
| 시간 중복 | **불가** (다른 경기와 시간이 겹치면 거부) |
| 초기 상태 | PENDING (호스트 승인 필요) |

### 시간 중복 체크 정책

| 상태 | 시간 중복 체크 대상 |
|------|-------------------|
| PENDING | **O** (체크 대상) |
| CONFIRMED | **O** (체크 대상) |
| CANCELLED | X (체크 제외) |
| REJECTED | X (체크 제외) |
| MATCH_CANCELLED | X (체크 제외) |

> **중요**: 활성 상태(PENDING, CONFIRMED)만 시간 중복 체크 대상입니다.

### 참가 취소 정책

| 항목 | 정책 |
|------|------|
| 취소 권한 | **본인만** 가능 |
| 취소 가능 상태 | PENDING, CONFIRMED |
| 취소 가능 시간 | 경기 시작 **2시간 전**까지 |
| 취소 후 상태 | → CANCELLED |
| 재신청 | **가능** |

### 재신청 정책

| 항목 | 정책 |
|------|------|
| 재신청 가능 상태 | **CANCELLED만** 가능 |
| REJECTED 재신청 | **불가** (거절된 경기에 재신청 불가) |
| 재신청 횟수 | **1회만 가능** (신중하게 결정 필요) |
| 구현 방식 | 기존 CANCELLED 레코드를 PENDING으로 재활성화 |
| DB 제약 | `(match_id, user_id)` UNIQUE 제약조건으로 인해 새 레코드 생성 불가 |
| UI 확인 | 참가 신청 시 확인 팝업 표시 |

### 호스트 액션 정책

#### 참가 승인
| 항목 | 정책 |
|------|------|
| 승인 권한 | **호스트만** 가능 |
| 승인 가능 상태 | PENDING |
| 승인 후 상태 | → CONFIRMED |
| 정원 반영 | currentParticipants + 1 |

#### 참가 거절
| 항목 | 정책 |
|------|------|
| 거절 권한 | **호스트만** 가능 |
| 거절 가능 상태 | PENDING |
| 거절 사유 | **필수** (API 요청 시 reason 필드 필수) |
| 거절 후 상태 | → REJECTED |
| 재신청 | **불가** |

---

## UI 피드백 정책

### 토스트 메시지

| 액션 | 성공 메시지 | 실패 시 |
|------|------------|--------|
| 참가 신청 | "참가 신청이 완료되었습니다" | API 에러 메시지 |
| 참가 취소 | "참가가 취소되었습니다" | API 에러 메시지 |
| 참가 승인 | "참가를 승인했습니다" | API 에러 메시지 |
| 참가 거절 | "참가를 거절했습니다" | API 에러 메시지 |
| 경기 취소 | "경기가 취소되었습니다" | API 에러 메시지 |
| 경기 복구 | "경기가 복구되었습니다" | API 에러 메시지 |

### 상태별 UI 표시 (참가자 화면)

| 참가 상태 | UI 표시 |
|----------|---------|
| 없음 | "참가 신청" 버튼 → 확인 팝업 표시 |
| PENDING | "호스트 승인 대기 중" + "신청 취소" 버튼 |
| CONFIRMED | "참가 확정!" + "참가 취소" 버튼 |
| CANCELLED | "참가 신청" 버튼 (재신청 가능) → 확인 팝업 표시 |
| REJECTED | "참가 신청이 거절되었습니다" (재신청 불가) |

### 참가 신청 확인 팝업 내용

참가 신청 시 다음 주의사항을 표시:
- 호스트가 거절하면 재신청이 불가능합니다.
- 신청 취소 후에도 1회만 재신청할 수 있습니다.
- 신중하게 결정해주세요.

---

## 도메인 이벤트

### ParticipationCreatedEvent
- **발생 시점**: 참가 신청 생성 또는 재활성화 시
- **데이터**: participationId, matchId, userId, matchTitle
- **구독자**: NotificationService → 호스트에게 알림

### ParticipationCancelledEvent
- **발생 시점**: 참가 취소 시
- **데이터**: participationId, matchId, userId, matchTitle
- **구독자**: NotificationService

### MatchCancelledEvent
- **발생 시점**: 경기 취소 시
- **데이터**: matchId, hostId, reason
- **구독자**: NotificationService → 참가자들에게 알림

---

## 에러 코드 정리

| 에러 코드 | HTTP 상태 | 설명 |
|----------|----------|------|
| HOST_CANNOT_PARTICIPATE | 400 | 호스트는 자기 경기에 참가 불가 |
| MATCH_FULL | 400 | 정원 마감 |
| INVALID_MATCH_STATUS | 400 | 참가 불가능한 경기 상태 |
| MATCH_ALREADY_STARTED | 400 | 이미 시작된 경기 |
| CANCEL_TIME_EXCEEDED | 400 | 취소 가능 시간 초과 |
| OVERLAPPING_PARTICIPATION | 400 | 시간 중복 참가 |
| ALREADY_PARTICIPATING | 409 | 이미 참가 신청함 |
| PARTICIPATION_NOT_FOUND | 404 | 참가 기록 없음 |
| MATCH_NOT_FOUND | 404 | 경기 없음 |
| NOT_HOST | 403 | 호스트 권한 없음 |
| NOT_PARTICIPANT | 403 | 참가자 권한 없음 |

---

## DB 제약사항

### participations 테이블
- `(match_id, user_id)` **UNIQUE** 제약조건
- 한 사용자는 한 경기에 하나의 참가 레코드만 가질 수 있음
- 재신청 시 새 레코드 생성이 아닌 기존 레코드 상태 변경 필요

### matches 테이블
- `status` ENUM: PENDING, CONFIRMED, FULL, IN_PROGRESS, ENDED, CANCELLED

---

## 변경 이력

| 날짜 | 변경 내용 |
|------|----------|
| 2026-01-15 | 참가 취소 후 재신청 정책 추가 |
| 2026-01-15 | REJECTED 재신청 불가 정책 확정 |
| 2026-01-15 | 시간 중복 체크 정책 명확화 (활성 상태만 체크) |
| 2026-01-15 | 경기 취소 시 취소 사유 필수 정책 추가 |
| 2026-01-15 | UI 피드백 정책 (토스트 메시지) 추가 |
| 2026-01-15 | 호스트 자동 참가 정책 명시 (currentParticipants = 1로 시작) |
| 2026-01-15 | 참가 신청 확인 팝업 추가 (재신청 주의사항 안내) |
| 2026-01-15 | 참가 거절 시 거절 사유 필수 정책 추가 |
