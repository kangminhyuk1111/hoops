# 사용자 플로우 분석

> 마지막 업데이트: 2026-01-12
> 관련 문서: [MVP 기능](./mvp-features.md) | [API 명세](../api/)

## 핵심 사용자 플로우

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         농구 경기 참가 플로우                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1. 회원가입          2. 로그인           3. 매치 조회                    │
│  ┌─────────┐        ┌─────────┐        ┌─────────┐                     │
│  │ 카카오   │───────▶│ JWT     │───────▶│ 목록    │                     │
│  │ OAuth   │        │ 발급    │        │ 조회    │                     │
│  └─────────┘        └─────────┘        └─────────┘                     │
│       │                                      │                          │
│       ▼                                      ▼                          │
│  ┌─────────┐                           ┌─────────┐                     │
│  │ 닉네임   │                           │ 상세    │ 4. 매치 상세 조회    │
│  │ 설정    │                           │ 조회    │                     │
│  └─────────┘                           └─────────┘                     │
│                                              │                          │
│                                              ▼                          │
│                                        ┌─────────┐                     │
│                                        │ 참가    │ 5. 참가 신청         │
│                                        │ 신청    │                     │
│                                        └─────────┘                     │
│                                              │                          │
│                                              ▼                          │
│                                        ┌─────────┐                     │
│                                        │ 호스트   │ 6. 승인/거절 ✅ 구현됨│
│                                        │ 승인    │                     │
│                                        └─────────┘                     │
│                                              │                          │
│                                              ▼                          │
│                                        ┌─────────┐                     │
│                                        │ 최종    │ 7. 참가 확정         │
│                                        │ 참가    │                     │
│                                        └─────────┘                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 플로우 단계별 분석

### 1단계: 회원가입

| 항목 | 상태 | 설명 |
|------|------|------|
| API | ✅ 구현됨 | `POST /api/auth/signup` |
| Cucumber 시나리오 | ⚠️ 미작성 | 회원가입 플로우 시나리오 필요 |
| 비고 | - | 카카오 OAuth 연동 후 닉네임 설정으로 완료 |

**관련 API**:
- `GET /api/auth/kakao` - 카카오 인증 URL 조회
- `GET /api/auth/kakao/callback` - 카카오 콜백 처리
- `POST /api/auth/signup` - 회원가입 완료

---

### 2단계: 로그인

| 항목 | 상태 | 설명 |
|------|------|------|
| API | ✅ 구현됨 | 카카오 OAuth + JWT 발급 |
| Cucumber 시나리오 | ⚠️ 미작성 | 로그인 플로우 시나리오 필요 |
| 비고 | - | 기존 회원은 콜백에서 바로 토큰 발급 |

**관련 API**:
- `GET /api/auth/kakao` - 카카오 인증 URL 조회
- `GET /api/auth/kakao/callback` - 로그인 처리 및 토큰 발급
- `POST /api/auth/refresh` - 토큰 갱신

---

### 3단계: 매치 조회 (목록)

| 항목 | 상태 | 설명 |
|------|------|------|
| API | ✅ 구현됨 | `GET /api/matches` |
| Cucumber 시나리오 | ✅ 작성됨 | 위치 기반 필터링 포함 |
| 비고 | - | 인증 없이 접근 가능 |

**관련 API**:
- `GET /api/matches?latitude=&longitude=&distance=` - 위치 기반 경기 목록 조회

---

### 4단계: 매치 상세 조회

| 항목 | 상태 | 설명 |
|------|------|------|
| API | ✅ 구현됨 | `GET /api/matches/{matchId}` |
| Cucumber 시나리오 | ✅ 작성됨 | 상세 조회 시나리오 존재 |
| 비고 | - | 인증 없이 접근 가능 |

**관련 API**:
- `GET /api/matches/{matchId}` - 경기 상세 조회
- `GET /api/matches/{matchId}/participants` - 참가자 목록 조회

---

### 5단계: 참가 신청

| 항목 | 상태 | 설명 |
|------|------|------|
| API | ✅ 구현됨 | `POST /api/matches/{matchId}/participations` |
| Cucumber 시나리오 | ⚠️ 미작성 | 참가 신청 시나리오 필요 |
| 비고 | ⚠️ 현재 자동 승인 | 신청 즉시 CONFIRMED 상태로 변경됨 |

**현재 동작** (자동 승인 - MVP 편의를 위해 유지):
```
참가 신청 → PENDING → (즉시) → CONFIRMED
```

**호스트 승인 플로우** (✅ 구현됨):
```
참가 신청 → PENDING → 호스트 승인 → CONFIRMED
                   → 호스트 거절 → REJECTED
```

> 참고: 현재 참가 신청 시 자동으로 CONFIRMED 되지만, 호스트가 approve/reject API를 통해 상태를 변경할 수 있습니다.

---

### 6단계: 호스트 승인/거절 ✅ 구현됨

| 항목 | 상태 | 설명 |
|------|------|------|
| API | ✅ 구현됨 | 승인/거절 API 완료 |
| Cucumber 시나리오 | ✅ 작성됨 | participation-approval.feature |
| 비고 | - | 호스트만 승인/거절 가능 |

**구현된 API**:
| API | Method | 설명 |
|-----|--------|------|
| `/api/matches/{matchId}/participations/{id}/approve` | PUT | 참가 승인 |
| `/api/matches/{matchId}/participations/{id}/reject` | PUT | 참가 거절 |

**필요한 알림**:
- 참가 신청 시 → 호스트에게 알림
- 승인 시 → 신청자에게 알림
- 거절 시 → 신청자에게 알림

---

### 7단계: 최종 참가

| 항목 | 상태 | 설명 |
|------|------|------|
| API | ⚠️ 6단계 의존 | 승인 후 CONFIRMED 상태 |
| Cucumber 시나리오 | ❌ 미작성 | - |
| 비고 | - | 6단계 구현 후 완성 |

---

## 누락된 API 목록

### 필수 (핵심 플로우) - ✅ 모두 구현됨

| 우선순위 | API | Method | 설명 | 상태 |
|----------|-----|--------|------|------|
| ~~🔴 P0~~ | `/api/matches/{matchId}/participations/{id}/approve` | PUT | 참가 승인 | ✅ 구현됨 |
| ~~🔴 P0~~ | `/api/matches/{matchId}/participations/{id}/reject` | PUT | 참가 거절 | ✅ 구현됨 |

### 권장 (사용자 경험 개선)

| 우선순위 | API | Method | 설명 |
|----------|-----|--------|------|
| 🟡 P1 | `/api/users/me/matches` | GET | 내가 생성한 경기 목록 |
| 🟡 P1 | `/api/users/{userId}` | GET | 다른 사용자 프로필 조회 |
| 🟢 P2 | `/api/users/me` | PUT | 프로필 수정 |
| 🟢 P2 | `/api/locations` | GET | 장소 목록 조회 |

---

## ParticipationStatus 상태 전이

### 현재 구현
```
PENDING ──(즉시)──▶ CONFIRMED ──(취소)──▶ CANCELLED
```

### 목표 구현
```
                    ┌──(승인)──▶ CONFIRMED ──(취소)──▶ CANCELLED
                    │
PENDING ────────────┤
                    │
                    └──(거절)──▶ REJECTED

* 경기 취소 시: CONFIRMED ──▶ MATCH_CANCELLED
```

**상태 정의**:
| 상태 | 설명 |
|------|------|
| PENDING | 참가 신청 대기 (호스트 승인 대기) |
| CONFIRMED | 참가 확정 |
| REJECTED | 호스트에 의해 거절됨 (신규) |
| CANCELLED | 참가자 본인이 취소 |
| MATCH_CANCELLED | 경기 자체가 취소됨 |

---

## 필요한 Cucumber 시나리오

### 참가 승인/거절 플로우 (신규)

```gherkin
# language: ko
기능: 경기 참가 승인/거절
  경기 호스트로서
  참가 신청을 승인하거나 거절할 수 있다

  배경:
    먼저 호스트가 로그인되어 있다
    그리고 호스트가 생성한 경기가 있다

  시나리오: 호스트가 참가 신청을 승인한다
    먼저 다른 사용자가 해당 경기에 참가 신청했다
    만일 호스트가 해당 참가 신청을 승인한다
    그러면 응답 상태 코드는 200 이다
    그리고 참가 상태가 CONFIRMED 이다
    그리고 신청자에게 승인 알림이 발송된다

  시나리오: 호스트가 참가 신청을 거절한다
    먼저 다른 사용자가 해당 경기에 참가 신청했다
    만일 호스트가 해당 참가 신청을 거절한다
    그러면 응답 상태 코드는 200 이다
    그리고 참가 상태가 REJECTED 이다
    그리고 신청자에게 거절 알림이 발송된다

  시나리오: 호스트가 아닌 사용자가 승인 시도
    먼저 다른 사용자가 해당 경기에 참가 신청했다
    그리고 제3의 사용자가 로그인했다
    만일 제3의 사용자가 해당 참가 신청을 승인한다
    그러면 응답 상태 코드는 403 이다
```

---

## 구현 우선순위

### Phase 1: 핵심 승인 플로우 (즉시)
1. ParticipationStatus에 `REJECTED` 추가
2. 참가 신청 시 자동 승인 로직 제거 (PENDING 유지)
3. 승인/거절 API 구현
4. 호스트용 대기 목록 조회 API 구현
5. 관련 알림 이벤트 추가

### Phase 2: 사용자 경험 (다음)
1. 내가 생성한 경기 목록 API
2. 다른 사용자 프로필 조회 API

### Phase 3: 부가 기능 (이후)
1. 프로필 수정 API
2. 장소 목록/검색 API

---

## 변경 이력

| 날짜 | 변경 내용 | 작성자 |
|------|----------|--------|
| 2026-01-12 | 최초 작성 - 사용자 플로우 분석 | Claude |
