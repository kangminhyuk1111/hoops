# Cucumber 테스트 트러블슈팅

## 1. DuplicateStepDefinitionException

**증상**: 동일한 스텝이 여러 StepDefs 클래스에 정의되면 예외 발생

```
io.cucumber.core.runner.DuplicateStepDefinitionException
```

**해결**: 공통 스텝은 `CommonStepDefs`에 정의하고, `SharedTestContext`로 상태 공유

```java
// SharedTestContext.java - 시나리오 간 상태 공유
@Component
@io.cucumber.spring.ScenarioScope
public class SharedTestContext {
    private TestResponse lastResponse;
    // getter, setter
}

// CommonStepDefs.java - 공통 스텝 정의
public class CommonStepDefs {
    private final SharedTestContext sharedContext;

    @그러면("응답 상태 코드는 {int} 이다")
    public void 응답_상태_코드는_이다(int expectedStatusCode) {
        assertThat(sharedContext.getLastResponse().statusCode())
            .isEqualTo(expectedStatusCode);
    }
}
```

**파일 위치**:
- `src/test/java/com/hoops/acceptance/steps/SharedTestContext.java`
- `src/test/java/com/hoops/acceptance/steps/CommonStepDefs.java`

---

## 2. Testcontainers MySQL Dialect 오류

**증상**: `generated by default as identity` SQL 문법 오류

```
java.sql.SQLSyntaxErrorException: ... 'by default as identity' ...
```

**원인**: Testcontainers가 MySQL을 사용하는데 H2Dialect가 설정됨

**해결**: `CucumberSpringConfiguration`에서 MySQL dialect 명시

```java
TestPropertySourceUtils.addInlinedPropertiesToEnvironment(
    context,
    "spring.datasource.url=" + mysql.getJdbcUrl(),
    // ... 기타 설정
    "spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQLDialect"  // 추가
);
```

---

## 3. 시나리오 간 데이터 중복 오류

**증상**: 두 번째 시나리오에서 Duplicate entry 오류

```
DataIntegrityViolationException: Duplicate entry '테스트유저' for key ...
```

**원인**: Feature의 `배경(Background)`이 각 시나리오마다 실행되어 동일 데이터 재삽입

**해결**: `@Before` 훅으로 시나리오 시작 전 DB 정리

```java
// DatabaseCleanupHook.java
public class DatabaseCleanupHook {
    @Autowired
    private JdbcTemplate jdbcTemplate;

    @Before(order = 0)
    public void cleanupDatabase() {
        jdbcTemplate.execute("SET FOREIGN_KEY_CHECKS = 0");
        jdbcTemplate.execute("TRUNCATE TABLE users");
        // 다른 테이블들...
        jdbcTemplate.execute("SET FOREIGN_KEY_CHECKS = 1");
    }
}
```

**파일 위치**: `src/test/java/com/hoops/acceptance/hooks/DatabaseCleanupHook.java`

---

## 4. 401 vs 403 응답 코드

**증상**: 인증 없는 요청에 401이 아닌 403 반환

**원인**: Spring Security 기본 설정은 403 반환

**해결**: `SecurityConfig`에 `authenticationEntryPoint` 설정

```java
.exceptionHandling(exception -> exception
    .authenticationEntryPoint(new HttpStatusEntryPoint(HttpStatus.UNAUTHORIZED))
)
```
