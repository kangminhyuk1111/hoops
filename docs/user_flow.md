# 핵심 유저 플로우 (User Flow)

> 이 문서는 **사용자의 핵심 해피 패스(Happy Path)**를 정의합니다.
> 사용자가 지도에서 경기를 찾아 신청하고 참여하는 전체 과정을 설명합니다.

---

## 🎯 핵심 해피 패스 (Happy Path)

### 전체 흐름 요약

```
1. 메인 화면 진입 → 지도에서 반경 2km 내 경기 조회
2. 지도 마커 클릭 → 경기 정보 확인
3. 경기 신청 → Host 승인 대기
4. Host 승인 → 경기 확정
5. 경기 참석 → 완료
```

---

## 📍 Step 1: 메인 화면 진입 및 경기 조회

### 사용자 행동

```
사용자가 앱을 실행
  ↓
메인 화면 진입
  ↓
GPS 위치 권한 요청
  ↓
현재 위치 기준 지도 표시
```

### 시스템 동작

```
1. 사용자의 현재 위치 획득 (위도, 경도)
2. 사용자 위치 기준 반경 2km 내 경기 검색
   - 경기 상태 = RECRUITING
   - 거리 계산: 직선 거리 기준
3. 검색된 경기들을 지도에 마커로 표시
   - 각 마커는 코트 위치에 표시
   - 마커 색상/모양으로 경기 상태 구분 가능
```

### UI 요소

| 요소 | 설명 |
|------|------|
| **지도** | 사용자 위치 중심으로 표시 |
| **마커** | 각 경기의 코트 위치에 마커 표시 |
| **내 위치** | 파란색 점으로 사용자 위치 표시 |
| **반경 표시** | 2km 반경 원으로 검색 범위 시각화 (선택적) |

### 데이터 조회

```sql
-- 예시 쿼리 (개념)
SELECT * FROM matches
WHERE status = 'RECRUITING'
  AND distance(user_location, court_location) <= 2000  -- 2km
ORDER BY distance ASC
```

---

## 🗺️ Step 2: 지도 마커 클릭 및 경기 정보 확인

### 사용자 행동

```
지도에서 마커 클릭
  ↓
경기 정보 팝업 표시
```

### 표시 정보

| 정보 | 예시 |
|------|------|
| **경기 날짜/시간** | 2025-12-28 오후 7:00 ~ 9:00 |
| **코트 이름** | 광주 시청 농구장 |
| **거리** | 1.2km |
| **현재 인원** | 승인됨 2명 / 최대 4명 |
| **Host 정보** | 이름, 신뢰도 점수 |
| **시설 정보** | 실내, 조명 있음, 주차 가능 |

### UI 요소

```
┌─────────────────────────────────┐
│  광주 시청 농구장               │
│  📍 1.2km                       │
│                                 │
│  📅 2025-12-28 오후 7:00       │
│  👥 승인됨 2명 / 최대 4명      │
│  ⭐ Host: 민혁 (4.5점)         │
│                                 │
│  실내 | 조명 있음 | 주차 가능  │
│                                 │
│  [ 신청하기 ]    [ 닫기 ]      │
└─────────────────────────────────┘
```

---

## ✅ Step 3: 경기 신청

### 사용자 행동

```
"신청하기" 버튼 클릭
  ↓
신청 확인 팝업
  ↓
"확인" 클릭
```

### 시스템 동작

```
1. 신청 가능 여부 검증
   ✓ 경기 상태 = RECRUITING
   ✓ 신뢰도 >= 2.0
   ✓ 중복 신청 없음
   ✓ 시간 겹침 없음

2. Participation 생성
   - userId: 현재 사용자
   - matchId: 선택한 경기
   - status: PENDING_APPROVAL
   - appliedAt: 현재 시간

3. Host에게 알림 발송
   - 채널: PUSH, IN_APP
   - 메시지: "새로운 신청이 있습니다"
```

### 신청 완료 화면

```
┌─────────────────────────────────┐
│  ✅ 신청이 완료되었습니다       │
│                                 │
│  Host의 승인을 기다리고 있어요  │
│  승인 결과는 알림으로 안내됩니다│
│                                 │
│  [ 확인 ]                       │
└─────────────────────────────────┘
```

### 사용자 상태

| 항목 | 값 |
|------|-----|
| **신청 상태** | PENDING_APPROVAL |
| **알림 수신** | Host 승인/거부 시 |
| **취소 가능** | 예 |

---

## 👍 Step 4: Host 승인 및 경기 확정

### Host의 행동

```
Host가 신청자 목록 확인
  ↓
신청자 프로필 확인 (신뢰도, 이름 등)
  ↓
"승인" 버튼 클릭
```

### 시스템 동작 (개별 승인)

```
1. Participation 상태 변경
   PENDING_APPROVAL → APPROVED

2. 신청자에게 알림 발송
   - 채널: PUSH, IN_APP
   - 메시지: "경기 신청이 승인되었습니다"

3. 승인된 참여자 수 확인
   approvedCount = 1 (Host) + 2 (승인된 신청자) = 3명
   → 아직 n명 미만 (대기)
```

### 시스템 동작 (n명 승인 완료)

```
Host가 (n-1)번째 신청자를 승인
  ↓
approvedCount = n (정원 완성)
  ↓
자동 처리:

1. Match 상태 변경
   RECRUITING → CONFIRMED

2. 모든 APPROVED Participation 상태 변경
   APPROVED → CONFIRMED

3. 모든 참여자에게 알림 발송
   - 채널: PUSH, IN_APP, SMS
   - 메시지: "경기가 확정되었습니다"
   - 경기 정보 포함 (날짜, 시간, 장소)
```

### 확정 알림 예시

```
┌─────────────────────────────────┐
│  🎉 경기가 확정되었습니다!      │
│                                 │
│  📅 2025-12-28 오후 7:00       │
│  📍 광주 시청 농구장            │
│                                 │
│  👥 참여자 4명                 │
│  - 민혁 (Host)                 │
│  - 철수                        │
│  - 영희                        │
│  - 나                          │
│                                 │
│  경기 1시간 전에 다시 알려드려요│
│                                 │
│  [ 확인 ]                       │
└─────────────────────────────────┘
```

---

## 🏀 Step 5: 경기 참석 및 완료

### 경기 시작 1시간 전

```
시스템이 자동으로 알림 발송
  ↓
모든 참여자에게 알림
  - 채널: PUSH, SMS
  - 메시지: "1시간 후 경기가 시작됩니다"
```

### 경기 시간 경과 후

```
경기 종료 시간 도달
  ↓
시스템이 참석 여부 확인 (방법은 구현에 따라)
  ↓
참석한 사용자:
  - Participation 상태: CONFIRMED → COMPLETED
  - 신뢰도: 유지 또는 상향 (+0.2)

미참석 사용자:
  - Participation 상태: CONFIRMED → NO_SHOW
  - 신뢰도: 감소 (-0.5)
  - 노쇼 카운트: +1
```

### 경기 완료 후 평가

```
참석한 사용자들은 서로 평가 가능
  ↓
평가 화면:
  - 상대방 선택
  - 별점 (1~5점)
  - 리뷰 작성 (선택)
  ↓
평가 제출
  ↓
상대방의 신뢰도 점수 자동 계산
```

---

## 🚫 예외 시나리오

### 시나리오 1: Host가 신청을 거부

```
Host가 "거부" 버튼 클릭
  ↓
Participation 상태: PENDING_APPROVAL → REJECTED
  ↓
신청자에게 알림 (선택적)
  - 메시지: "경기 신청이 거부되었습니다"
  ↓
신청자는 다른 경기 찾기 가능
```

### 시나리오 2: 신청자가 신청 취소

```
신청자가 "신청 취소" 버튼 클릭
  ↓
Participation 상태: PENDING_APPROVAL/APPROVED → CANCELLED
  ↓
Host에게 알림
  - 메시지: "신청자가 취소했습니다"
  ↓
신뢰도 영향 없음
```

### 시나리오 3: Host가 경기 취소

```
Host가 "경기 취소" 버튼 클릭
  ↓
Match 상태: RECRUITING/CONFIRMED → CANCELLED
  ↓
모든 Participation 상태: CANCELLED
  ↓
모든 신청자/참여자에게 알림
  - 메시지: "경기가 취소되었습니다"
```

### 시나리오 4: 노쇼 발생

```
경기 시간 경과
  ↓
시스템이 참석 여부 확인
  ↓
미참석 확인
  ↓
Participation 상태: CONFIRMED → NO_SHOW
  ↓
신뢰도 -0.5
노쇼 카운트 +1
  ↓
노쇼 3회 이상 → 사용자 자동 정지
```

---

## 📊 상태 추적 다이어그램

### 신청자 관점에서 본 전체 플로우

```
[메인 화면]
    ↓
[지도에서 경기 검색]
    ↓
[마커 클릭 → 경기 정보 확인]
    ↓
[신청하기]
    ↓
PENDING_APPROVAL (승인 대기)
    ↓
    ├→ Host 승인 → APPROVED (승인됨)
    │                ↓
    │           Host가 n명 승인 완료
    │                ↓
    │           CONFIRMED (확정됨)
    │                ↓
    │           경기 시작 1시간 전 알림
    │                ↓
    │           경기 시간 경과
    │                ↓
    │           ├→ 참석 → COMPLETED (완료)
    │           └→ 미참석 → NO_SHOW (노쇼)
    │
    └→ Host 거부 → REJECTED (거부됨)
```

---

## 🎨 UI/UX 고려사항

### 지도 화면

| 요소 | 설명 |
|------|------|
| **마커 색상** | 녹색: 모집 중 (RECRUITING), 회색: 확정됨 (CONFIRMED) |
| **마커 클러스터링** | 가까운 마커들은 숫자로 그룹화 |
| **내 위치 버튼** | 클릭 시 내 위치로 지도 중심 이동 |
| **반경 조절** | 슬라이더로 검색 반경 조절 (1km ~ 5km) |

### 경기 정보 팝업

```
- 간결한 정보 표시
- 스크롤 없이 핵심 정보 확인 가능
- CTA 버튼 명확히 표시
- 거리 정보 강조
```

### 알림 전략

| 상황 | 채널 | 우선순위 |
|------|------|---------|
| 신청됨 (Host에게) | PUSH, IN_APP | 중 |
| 승인됨 (신청자에게) | PUSH, IN_APP | 높음 |
| 경기 확정 | PUSH, IN_APP, SMS | 매우 높음 |
| 경기 1시간 전 | PUSH, SMS | 매우 높음 |
| 경기 취소 | PUSH, IN_APP, SMS | 매우 높음 |

---

## 📋 체크리스트

### 구현 전 확인사항

```
□ GPS 권한 획득 로직 구현
□ 지도 SDK 연동 (Google Maps / Naver Maps / Kakao Maps)
□ 거리 계산 로직 구현 (Haversine 공식)
□ 마커 클러스터링 구현
□ 실시간 위치 업데이트 (선택적)
□ 알림 발송 시스템 구현
□ 참석 여부 확인 로직 (QR, 체크인 등)
```

### 사용자 경험 확인

```
□ 지도 로딩 속도 최적화
□ 마커 클릭 반응 속도
□ 신청 버튼 클릭 후 피드백 명확
□ 승인 대기 상태 명확히 표시
□ 경기 확정 시 축하 애니메이션 (선택적)
□ 오프라인 시나리오 처리
```

---

**이 유저 플로우는 사용자의 핵심 경험을 정의합니다. UI/UX 설계 시 반드시 참고하세요.**
